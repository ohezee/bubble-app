<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Bubble">
    <meta name="description" content="Visual bubble-based task manager with smart prioritization">
    <meta name="theme-color" content="#5D9CEC">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Icons -->
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
    
    <title>Bubble</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #2C3E50 0%, #34495E 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        /* Decorative background bubbles */
        .bg-bubbles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-bubble {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(93, 156, 236, 0.25), rgba(93, 156, 236, 0.08));
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                inset 0 0 20px rgba(255, 255, 255, 0.1),
                0 0 20px rgba(93, 156, 236, 0.2);
            animation: floatUp linear infinite;
            opacity: 0;
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) translateX(0) scale(0.8);
                opacity: 0;
            }
            5% {
                opacity: 0.8;
            }
            95% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(-120vh) translateX(50px) scale(1.2);
                opacity: 0;
            }
        }

        @keyframes floatDiagonal {
            0% {
                transform: translateY(0) translateX(0) scale(0.8);
                opacity: 0;
            }
            5% {
                opacity: 0.8;
            }
            95% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(-120vh) translateX(100px) scale(1.1);
                opacity: 0;
            }
        }

        @keyframes floatLeft {
            0% {
                transform: translateY(0) translateX(0) scale(0.8);
                opacity: 0;
            }
            5% {
                opacity: 0.8;
            }
            95% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(-120vh) translateX(-80px) scale(1.15);
                opacity: 0;
            }
        }

        @keyframes floatWave {
            0% {
                transform: translateY(0) translateX(0) scale(0.8);
                opacity: 0;
            }
            5% {
                opacity: 0.8;
            }
            25% {
                transform: translateY(-30vh) translateX(30px) scale(0.9);
            }
            50% {
                transform: translateY(-60vh) translateX(-20px) scale(1);
            }
            75% {
                transform: translateY(-90vh) translateX(40px) scale(1.1);
            }
            95% {
                opacity: 0.7;
            }
            100% {
                transform: translateY(-120vh) translateX(0px) scale(1.2);
                opacity: 0;
            }
        }

        /* Individual bubble sizes and positions - 20 bubbles from all directions */
        .bg-bubble:nth-child(1) {
            width: 100px;
            height: 100px;
            left: 5%;
            bottom: -200px;
            animation: floatUp 35s linear infinite;
            animation-delay: 0s;
        }

        .bg-bubble:nth-child(2) {
            width: 60px;
            height: 60px;
            left: 15%;
            bottom: -200px;
            animation: floatDiagonal 40s linear infinite;
            animation-delay: 5s;
        }

        .bg-bubble:nth-child(3) {
            width: 120px;
            height: 120px;
            left: 25%;
            bottom: -200px;
            animation: floatWave 45s linear infinite;
            animation-delay: 2s;
        }

        .bg-bubble:nth-child(4) {
            width: 70px;
            height: 70px;
            left: 35%;
            bottom: -200px;
            animation: floatLeft 38s linear infinite;
            animation-delay: 8s;
        }

        .bg-bubble:nth-child(5) {
            width: 110px;
            height: 110px;
            left: 45%;
            bottom: -200px;
            animation: floatUp 42s linear infinite;
            animation-delay: 3s;
        }

        .bg-bubble:nth-child(6) {
            width: 80px;
            height: 80px;
            left: 55%;
            bottom: -200px;
            animation: floatDiagonal 36s linear infinite;
            animation-delay: 10s;
        }

        .bg-bubble:nth-child(7) {
            width: 65px;
            height: 65px;
            left: 65%;
            bottom: -200px;
            animation: floatWave 39s linear infinite;
            animation-delay: 6s;
        }

        .bg-bubble:nth-child(8) {
            width: 95px;
            height: 95px;
            left: 75%;
            bottom: -200px;
            animation: floatLeft 37s linear infinite;
            animation-delay: 9s;
        }

        .bg-bubble:nth-child(9) {
            width: 75px;
            height: 75px;
            left: 85%;
            bottom: -200px;
            animation: floatUp 41s linear infinite;
            animation-delay: 12s;
        }

        .bg-bubble:nth-child(10) {
            width: 85px;
            height: 85px;
            left: 95%;
            bottom: -200px;
            animation: floatDiagonal 43s linear infinite;
            animation-delay: 15s;
        }

        .bg-bubble:nth-child(11) {
            width: 90px;
            height: 90px;
            left: 8%;
            bottom: -200px;
            animation: floatWave 44s linear infinite;
            animation-delay: 4s;
        }

        .bg-bubble:nth-child(12) {
            width: 55px;
            height: 55px;
            left: 20%;
            bottom: -200px;
            animation: floatUp 34s linear infinite;
            animation-delay: 7s;
        }

        .bg-bubble:nth-child(13) {
            width: 105px;
            height: 105px;
            left: 32%;
            bottom: -200px;
            animation: floatLeft 46s linear infinite;
            animation-delay: 1s;
        }

        .bg-bubble:nth-child(14) {
            width: 68px;
            height: 68px;
            left: 42%;
            bottom: -200px;
            animation: floatDiagonal 33s linear infinite;
            animation-delay: 11s;
        }

        .bg-bubble:nth-child(15) {
            width: 115px;
            height: 115px;
            left: 52%;
            bottom: -200px;
            animation: floatWave 48s linear infinite;
            animation-delay: 13s;
        }

        .bg-bubble:nth-child(16) {
            width: 78px;
            height: 78px;
            left: 62%;
            bottom: -200px;
            animation: floatUp 35s linear infinite;
            animation-delay: 16s;
        }

        .bg-bubble:nth-child(17) {
            width: 63px;
            height: 63px;
            left: 72%;
            bottom: -200px;
            animation: floatLeft 40s linear infinite;
            animation-delay: 14s;
        }

        .bg-bubble:nth-child(18) {
            width: 92px;
            height: 92px;
            left: 82%;
            bottom: -200px;
            animation: floatDiagonal 38s linear infinite;
            animation-delay: 18s;
        }

        .bg-bubble:nth-child(19) {
            width: 72px;
            height: 72px;
            left: 90%;
            bottom: -200px;
            animation: floatWave 42s linear infinite;
            animation-delay: 20s;
        }

        .bg-bubble:nth-child(20) {
            width: 88px;
            height: 88px;
            left: 12%;
            bottom: -200px;
            animation: floatUp 37s linear infinite;
            animation-delay: 17s;
        }

        .container {
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeIn 0.6s ease-out;
            position: relative;
        }

        .menu-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            width: 45px;
            height: 45px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1001;
            -webkit-tap-highlight-color: transparent;
        }

        .menu-btn:active {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-50%) scale(0.95);
        }

        .menu-btn span {
            width: 22px;
            height: 2px;
            background: #ECF0F1;
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .logo-container {
            display: inline-flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .logo-bubble {
            width: 60px;
            height: 60px;
            position: relative;
            animation: logoFloat 3s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(5deg); }
        }

        .header h1 {
            font-size: 48px;
            background: linear-gradient(135deg, #ECF0F1 0%, #5D9CEC 50%, #A29BFE 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
            letter-spacing: 3px;
            margin: 0;
            display: inline-block;
            text-shadow: 0 2px 10px rgba(93, 156, 236, 0.3);
            filter: drop-shadow(0 2px 10px rgba(93, 156, 236, 0.3));
        }

        .header p {
            color: #95A5A6;
            font-size: 16px;
            margin-top: 10px;
            font-weight: 300;
        }

        .add-category-container {
            max-width: 500px;
            margin: 0 auto 40px;
            display: flex;
            gap: 10px;
            animation: slideDown 0.6s ease-out 0.2s both;
        }

        .category-input {
            flex: 1;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid #4A5F7F;
            border-radius: 25px;
            background: rgba(255,255,255,0.05);
            color: #ECF0F1;
            outline: none;
            transition: all 0.3s ease;
        }

        .category-input::placeholder {
            color: #7F8C8D;
        }

        .category-input:focus {
            border-color: #5D9CEC;
            background: rgba(255,255,255,0.08);
            box-shadow: 0 0 20px rgba(93, 156, 236, 0.2);
        }

        .add-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #5D9CEC, #4A89DC);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(93, 156, 236, 0.3);
            font-weight: 300;
            -webkit-tap-highlight-color: transparent;
        }

        .add-btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(93, 156, 236, 0.4);
        }

        .bubbles-container {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            padding: 20px;
            width: 100%;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .bubbles-container {
                gap: 20px;
                padding: 10px;
                max-width: 100%;
            }
            
            .category-wrapper {
                margin: 10px;
            }
            
            .bubble {
                min-width: 150px;
                min-height: 150px;
                max-width: 250px;
                max-height: 250px;
            }
            
            .header h1 {
                font-size: 36px;
            }
        }

        @media (max-width: 480px) {
            .bubbles-container {
                gap: 15px;
                padding: 5px;
            }
            
            .category-wrapper {
                margin: 8px;
            }
            
            .bubble {
                min-width: 140px;
                min-height: 140px;
                max-width: 200px;
                max-height: 200px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 28px;
            }
        }

        .category-wrapper {
            position: relative;
            margin: 20px;
            transition: opacity 0.4s ease;
            will-change: transform;
        }

        .category-wrapper.inactive {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }

        .bubble {
            /* Size is now dynamic - set via inline style */
            min-width: 170px;
            min-height: 170px;
            max-width: 300px;
            max-height: 300px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 30px;
            cursor: pointer;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            animation: float 4s ease-in-out infinite;
            overflow: visible;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
        }

        .bubble:active {
            transform: scale(0.95);
        }

        .bubble.popped {
            transform: scale(0.3);
            opacity: 0.1;
            animation: bubblePop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bubblePop {
            0% { 
                transform: scale(1);
                opacity: 1;
            }
            30% { 
                transform: scale(1.3);
                opacity: 0.8;
            }
            60% {
                transform: scale(0.8);
                opacity: 0.4;
            }
            100% { 
                transform: scale(0.3);
                opacity: 0.1;
            }
        }

        /* Pop particles */
        .pop-particle {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes particleBurst {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        /* Ripple effect */
        .ripple {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.6);
            pointer-events: none;
            z-index: 9;
            animation: rippleExpand 0.8s ease-out;
        }

        @keyframes rippleExpand {
            0% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2.5);
                opacity: 0;
            }
        }

        /* Shatter lines */
        .shatter-line {
            position: absolute;
            width: 2px;
            height: 60px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), transparent);
            pointer-events: none;
            z-index: 9;
            transform-origin: bottom center;
        }

        @keyframes shatterExpand {
            0% {
                transform: translateY(0) scaleY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px) scaleY(1.5);
                opacity: 0;
            }
        }

        .bubble::before {
            content: '';
            position: absolute;
            top: 20%;
            left: 25%;
            width: 35%;
            height: 25%;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            transform: rotate(-30deg);
        }

        .bubble:hover {
            transform: scale(1.08) translateY(-8px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.4);
        }

        .bubble.popped:hover {
            transform: scale(1.2);
        }

        .bubble:active {
            transform: scale(0.98);
        }

        .bubble.expanded {
            animation: none;
        }

        .bubble-text {
            color: white;
            font-size: 18px;
            font-weight: 400;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            z-index: 1;
            word-wrap: break-word;
            max-width: 100%;
        }

        .task-count {
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            margin-top: 8px;
            font-weight: 300;
        }

        .delete-category {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            background: rgba(0,0,0,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            opacity: 0.7; /* Always visible on mobile */
            transition: opacity 0.3s ease;
            font-weight: 300;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
        }

        .delete-category:active {
            opacity: 1;
            background: rgba(231, 76, 60, 0.8);
        }

        /* Show on desktop hover, but always visible on mobile */
        @media (hover: hover) {
            .delete-category {
                opacity: 0;
            }
            .bubble:hover .delete-category {
                opacity: 1;
            }
        }

        .tasks-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            pointer-events: none;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .tasks-panel.expanded {
            pointer-events: auto;
            opacity: 1;
        }

        .task-list {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .task-bubble {
            position: absolute;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            animation: taskBubbleEmerge 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) backwards;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            overflow: hidden;
        }

        .task-bubble:active {
            transform: translate(-50%, -50%) scale(0.95);
        }

        /* Completed tasks - small and faded */
        .task-bubble.completed {
            opacity: 0.4;
            background: rgba(255,255,255,0.05);
            animation: taskShrink 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes taskShrink {
            0% { 
                transform: translate(-50%, -50%) scale(1.75);
            }
            100% { 
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .task-bubble::before {
            content: '';
            position: absolute;
            top: 15%;
            left: 20%;
            width: 35%;
            height: 25%;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0) 70%);
            border-radius: 50%;
            transform: rotate(-30deg);
        }

        .task-bubble:hover {
            transform: translate(-50%, -50%) scale(1.15);
            box-shadow: 0 12px 35px rgba(0,0,0,0.4);
        }

        .task-bubble.completed:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }

        .task-bubble.completed .task-bubble-text {
            text-decoration: line-through;
            font-size: 11px;
        }

        @keyframes taskBubbleEmerge {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            60% {
                transform: translate(-50%, -50%) scale(1.15);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        .task-bubble-text {
            color: white;
            font-size: 14px;
            font-weight: 400;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            z-index: 1;
            word-wrap: break-word;
            max-width: 90%;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .task-bubble-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            background: rgba(231, 76, 60, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            opacity: 0.6; /* Always visible on mobile */
            transition: opacity 0.3s ease;
            font-weight: bold;
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
        }

        .task-bubble-delete:active {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Show on desktop hover, but always visible on mobile */
        @media (hover: hover) {
            .task-bubble-delete {
                opacity: 0;
            }
            .task-bubble:hover .task-bubble-delete {
                opacity: 1;
            }
        }

        /* New Task bubble - fixed to bottom right for easy thumb access */
        .new-task-bubble {
            position: fixed;
            right: max(20px, calc(env(safe-area-inset-right) + 20px));
            bottom: max(20px, calc(env(safe-area-inset-bottom) + 20px));
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #5D9CEC, #4A89DC);
            border: none;
            box-shadow: 0 8px 25px rgba(93, 156, 236, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 999;
            -webkit-tap-highlight-color: transparent;
        }

        .new-task-bubble:active {
            transform: scale(0.9);
            box-shadow: 0 4px 15px rgba(93, 156, 236, 0.6);
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 8px 25px rgba(93, 156, 236, 0.5);
            }
            50% {
                box-shadow: 0 8px 35px rgba(93, 156, 236, 0.7);
            }
        }

        .new-task-bubble {
            animation: pulse 2s ease-in-out infinite;
        }

        .new-task-bubble-icon {
            font-size: 32px;
            color: white;
            line-height: 1;
        }

        .new-task-bubble-text {
            display: none; /* Hide text, just show + icon for compact button */
        }

        /* AI Prioritize Button */
        .ai-prioritize-btn {
            position: absolute;
            bottom: 5%;
            right: 5%;
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(142, 68, 173, 0.4), rgba(155, 89, 182, 0.4));
            border: 2px solid rgba(142, 68, 173, 0.6);
            border-radius: 20px;
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: taskBubbleEmerge 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) backwards;
            animation-delay: 0.6s;
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);
            font-weight: 400;
        }

        .ai-prioritize-btn:hover {
            background: linear-gradient(135deg, rgba(142, 68, 173, 0.6), rgba(155, 89, 182, 0.6));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(142, 68, 173, 0.4);
        }

        .ai-prioritize-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Side Panel */
        .side-panel {
            position: fixed;
            left: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background: linear-gradient(135deg, #2C3E50 0%, #34495E 100%);
            box-shadow: 2px 0 20px rgba(0,0,0,0.3);
            transition: left 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
            overflow-y: auto;
            padding: 80px 30px 30px 30px;
        }

        .side-panel.open {
            left: 0;
        }

        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .panel-section {
            margin-bottom: 30px;
        }

        .panel-section h3 {
            color: #ECF0F1;
            font-size: 14px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            color: #95A5A6;
        }

        .panel-item {
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            -webkit-tap-highlight-color: transparent;
        }

        .panel-item:active {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
            transform: scale(0.98);
        }

        /* Only show transform on desktop hover */
        @media (hover: hover) {
            .panel-item:hover {
                background: rgba(255,255,255,0.1);
                border-color: rgba(255,255,255,0.2);
                transform: translateX(5px);
            }
        }

        .panel-item-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .panel-item-text {
            flex: 1;
            color: #ECF0F1;
            font-size: 16px;
            font-weight: 300;
        }

        .panel-item-badge {
            background: rgba(93, 156, 236, 0.3);
            color: #5D9CEC;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .panel-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .panel-toggle-label {
            color: #ECF0F1;
            font-size: 16px;
            font-weight: 300;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: rgba(255,255,255,0.1);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch.active {
            background: linear-gradient(135deg, #5D9CEC, #4A89DC);
        }

        .toggle-switch-knob {
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: all 0.3s ease;
        }

        .toggle-switch.active .toggle-switch-knob {
            left: 27px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .stat-card:active {
            background: rgba(255,255,255,0.1);
            transform: scale(0.95);
        }

        @media (hover: hover) {
            .stat-card:hover {
                background: rgba(255,255,255,0.1);
                border-color: rgba(93, 156, 236, 0.5);
            }
        }

        .stat-number {
            font-size: 28px;
            font-weight: 500;
            color: #5D9CEC;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #95A5A6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* List View Modal */
        .list-view-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: none;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .list-view-modal.active {
            display: block;
        }

        .list-view-content {
            max-width: 800px;
            margin: 60px auto 40px;
            padding: 30px;
            padding-bottom: max(40px, calc(env(safe-area-inset-bottom) + 40px));
        }

        .list-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        .list-view-title {
            font-size: 32px;
            color: #ECF0F1;
            font-weight: 500;
        }

        .list-view-close {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .list-view-close:active {
            background: rgba(255,255,255,0.2);
            transform: scale(0.9);
        }

        .list-category-section {
            margin-bottom: 30px;
        }

        .list-category-header {
            font-size: 20px;
            color: #5D9CEC;
            margin-bottom: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .list-category-count {
            font-size: 14px;
            color: #95A5A6;
            font-weight: 300;
        }

        .list-task-item {
            background: rgba(255,255,255,0.05);
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .list-task-item:active {
            background: rgba(255,255,255,0.1);
            transform: scale(0.98);
        }

        .list-task-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(93, 156, 236, 0.6);
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .list-task-item.completed .list-task-checkbox {
            background: linear-gradient(135deg, #5D9CEC, #4A89DC);
            border-color: #5D9CEC;
        }

        .list-task-checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .list-task-item.completed .list-task-checkbox::after {
            opacity: 1;
        }

        .list-task-text {
            flex: 1;
            color: #ECF0F1;
            font-size: 16px;
            font-weight: 300;
        }

        .list-task-item.completed .list-task-text {
            text-decoration: line-through;
            opacity: 0.5;
        }

        .list-task-time {
            font-size: 12px;
            color: #95A5A6;
            white-space: nowrap;
        }

        .empty-list {
            text-align: center;
            padding: 60px 20px;
            color: #95A5A6;
            font-size: 18px;
            font-weight: 300;
        }

        /* Edit Menu Modal */
        .edit-menu {
            position: fixed;
            bottom: -400px;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, #2C3E50 0%, #34495E 100%);
            border-radius: 20px 20px 0 0;
            padding: 30px;
            padding-bottom: max(30px, calc(env(safe-area-inset-bottom) + 30px));
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            z-index: 3000;
            transition: bottom 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .edit-menu.active {
            bottom: 0;
        }

        .edit-menu-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .edit-menu-handle {
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin: 0 auto 15px;
        }

        .edit-menu-title {
            font-size: 18px;
            color: #ECF0F1;
            font-weight: 500;
        }

        .edit-menu-item {
            padding: 18px 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
            -webkit-tap-highlight-color: transparent;
        }

        .edit-menu-item:active {
            background: rgba(255,255,255,0.15);
            transform: scale(0.98);
        }

        .edit-menu-item-icon {
            font-size: 24px;
            width: 30px;
            text-align: center;
        }

        .edit-menu-item-text {
            flex: 1;
            color: #ECF0F1;
            font-size: 16px;
            font-weight: 300;
        }

        .edit-menu-item.danger {
            border-color: rgba(231, 76, 60, 0.3);
        }

        .edit-menu-item.danger .edit-menu-item-text {
            color: #E74C3C;
        }

        .edit-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .edit-menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Rename Input Modal */
        .rename-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: linear-gradient(135deg, #2C3E50 0%, #34495E 100%);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            z-index: 4000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 400px;
            width: 90%;
        }

        .rename-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .rename-modal h3 {
            color: #ECF0F1;
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .rename-modal input {
            width: 100%;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid rgba(93, 156, 236, 0.5);
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            color: #ECF0F1;
            outline: none;
            margin-bottom: 20px;
        }

        .rename-modal-buttons {
            display: flex;
            gap: 10px;
        }

        .rename-modal button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 400;
            -webkit-tap-highlight-color: transparent;
        }

        .rename-modal button.cancel {
            background: rgba(255,255,255,0.1);
            color: #ECF0F1;
        }

        .rename-modal button.cancel:active {
            background: rgba(255,255,255,0.15);
        }

        .rename-modal button.save {
            background: linear-gradient(135deg, #5D9CEC, #4A89DC);
            color: white;
        }

        .rename-modal button.save:active {
            transform: scale(0.98);
        }

        .task-input-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .task-input-overlay.active {
            display: flex;
        }

        .task-input-box {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            max-width: 500px;
            width: 90%;
        }

        .task-input-box input {
            width: 100%;
            padding: 15px 20px;
            font-size: 16px;
            border: 2px solid rgba(93, 156, 236, 0.5);
            border-radius: 25px;
            background: rgba(255,255,255,0.05);
            color: #ECF0F1;
            outline: none;
            font-weight: 300;
            margin-bottom: 15px;
        }

        .task-input-box input::placeholder {
            color: #7F8C8D;
        }

        .date-picker-label {
            color: #95A5A6;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .date-picker-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .date-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            color: #ECF0F1;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 300;
        }

        .date-btn:hover {
            background: rgba(93, 156, 236, 0.2);
            border-color: rgba(93, 156, 236, 0.5);
        }

        .date-btn.selected {
            background: linear-gradient(135deg, #5D9CEC, #4A89DC);
            border-color: #5D9CEC;
            font-weight: 400;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-8px) rotate(1deg); }
            50% { transform: translateY(-4px) rotate(-1deg); }
            75% { transform: translateY(-10px) rotate(0.5deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .empty-state {
            text-align: center;
            color: #7F8C8D;
            font-size: 20px;
            margin-top: 60px;
            opacity: 0.7;
            animation: fadeIn 0.6s ease-out;
            font-weight: 300;
        }

        /* Mature color palette */
        .bubble:nth-child(6n+1) { background: linear-gradient(135deg, #5D9CEC, #4A89DC); animation-delay: 0s; }
        .bubble:nth-child(6n+2) { background: linear-gradient(135deg, #AC92EC, #967ADC); animation-delay: 0.3s; }
        .bubble:nth-child(6n+3) { background: linear-gradient(135deg, #48CFAD, #37BC9B); animation-delay: 0.6s; }
        .bubble:nth-child(6n+4) { background: linear-gradient(135deg, #FFCE54, #F6BB42); animation-delay: 0.9s; }
        .bubble:nth-child(6n+5) { background: linear-gradient(135deg, #ED5565, #DA4453); animation-delay: 1.2s; }
        .bubble:nth-child(6n+6) { background: linear-gradient(135deg, #FC6E51, #E9573F); animation-delay: 1.5s; }
    </style>
</head>
<body>
    <!-- Decorative background bubbles -->
    <div class="bg-bubbles">
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
        <div class="bg-bubble"></div>
    </div>

    <div class="container">
    
    <div class="panel-overlay" id="panelOverlay" onclick="toggleSidePanel()"></div>
    
    <div class="side-panel" id="sidePanel">
        <div class="panel-section">
            <h3>Overview</h3>
            <div class="stats-grid">
                <div class="stat-card" onclick="showTotalTasks()">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card" onclick="showCompletedTasks()">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card" onclick="showAllCategories()">
                    <div class="stat-number" id="totalCategories">0</div>
                    <div class="stat-label">Categories</div>
                </div>
                <div class="stat-card" onclick="showTodayCompleted()">
                    <div class="stat-number" id="todayCompleted">0</div>
                    <div class="stat-label">Done Today</div>
                </div>
            </div>
        </div>

        <div class="panel-section">
            <h3>Navigation</h3>
            <div class="panel-item" onclick="showHistory()">
                <div class="panel-item-icon">üìú</div>
                <div class="panel-item-text">History</div>
            </div>
            <div class="panel-item" onclick="showAllTasks()">
                <div class="panel-item-icon">üìã</div>
                <div class="panel-item-text">All Tasks</div>
                <div class="panel-item-badge" id="activeBadge">0 active</div>
            </div>
        </div>

        <div class="panel-section">
            <h3>Settings</h3>
            <div class="panel-toggle">
                <div class="panel-toggle-label">
                    <span>üîä</span>
                    <span>Sound Effects</span>
                </div>
                <div class="toggle-switch" id="soundToggle" onclick="toggleSound(event)">
                    <div class="toggle-switch-knob"></div>
                </div>
            </div>
            <div class="panel-toggle">
                <div class="panel-toggle-label">
                    <span>üåô</span>
                    <span>Dark Mode</span>
                </div>
                <div class="toggle-switch active" id="darkModeToggle" onclick="toggleDarkMode(event)">
                    <div class="toggle-switch-knob"></div>
                </div>
            </div>
        </div>

        <div class="panel-section">
            <h3>Data</h3>
            <div class="panel-item" onclick="exportData()">
                <div class="panel-item-icon">üì§</div>
                <div class="panel-item-text">Export Data</div>
            </div>
            <div class="panel-item" onclick="importData()">
                <div class="panel-item-icon">üì•</div>
                <div class="panel-item-text">Import Data</div>
            </div>
            <div class="panel-item" onclick="clearAllData()">
                <div class="panel-item-icon">üóëÔ∏è</div>
                <div class="panel-item-text">Clear All Data</div>
            </div>
        </div>
    </div>

    <div class="header">
        <button class="menu-btn" id="menuBtn" onclick="toggleSidePanel()">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="logo-container">
            <svg class="logo-bubble" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="bubbleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#5D9CEC;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#4A89DC;stop-opacity:1" />
                    </linearGradient>
                    <radialGradient id="bubbleShine" cx="30%" cy="30%">
                        <stop offset="0%" style="stop-color:white;stop-opacity:0.6" />
                        <stop offset="50%" style="stop-color:white;stop-opacity:0.2" />
                        <stop offset="100%" style="stop-color:white;stop-opacity:0" />
                    </radialGradient>
                </defs>
                <circle cx="50" cy="50" r="45" fill="url(#bubbleGradient)" opacity="0.9"/>
                <ellipse cx="35" cy="30" rx="20" ry="15" fill="url(#bubbleShine)" transform="rotate(-30 35 30)"/>
                <circle cx="70" cy="65" r="3" fill="white" opacity="0.4"/>
                <circle cx="75" cy="70" r="2" fill="white" opacity="0.3"/>
            </svg>
            <h1>Bubble</h1>
        </div>
        <p>click a category to expand ‚Ä¢ add tasks within</p>
    </div>

    <div class="add-category-container">
        <input 
            type="text" 
            class="category-input" 
            placeholder="New category (e.g., Work, Personal, Health)"
            id="categoryInput"
        >
        <button class="add-btn" onclick="addCategory()">+</button>
    </div>

    <div class="bubbles-container" id="bubblesContainer">
        <div class="empty-state">Create your first category to get started</div>
    </div>

    <div class="task-input-overlay" id="taskInputOverlay" onclick="if(event.target === this) hideTaskInput()">
        <div class="task-input-box">
            <input 
                type="text" 
                id="taskInputField"
                placeholder="Enter task name..."
                onkeypress="submitTask(event)"
            >
            <div class="date-picker-label">When?</div>
            <div class="date-picker-buttons">
                <button class="date-btn" data-days="0" onclick="selectDate(0, event)">Today</button>
                <button class="date-btn" data-days="1" onclick="selectDate(1, event)">Tomorrow</button>
                <button class="date-btn" data-days="7" onclick="selectDate(7, event)">This Week</button>
                <button class="date-btn selected" data-days="null" onclick="selectDate(null, event)">Someday</button>
            </div>
        </div>
    </div>

    <script>
        let categories = [];
        let expandedCategory = null;

        // Load from localStorage
        function loadData() {
            const saved = localStorage.getItem('bubbleCategories');
            if (saved) {
                categories = JSON.parse(saved);
                renderBubbles();
            }
        }

        // Save to localStorage
        function saveData() {
            localStorage.setItem('bubbleCategories', JSON.stringify(categories));
        }

        // Add new category
        function addCategory() {
            const input = document.getElementById('categoryInput');
            const name = input.value.trim();
            
            if (name === '') return;
            playSound('add');
            
            categories.push({
                id: Date.now(),
                name: name,
                tasks: [],
                lastAIPrioritization: null
            });
            
            input.value = '';
            saveData();
            renderBubbles(true); // Force physics restart - new category added
        }

        // Delete category
        function deleteCategory(id, event) {
            event.stopPropagation();
            
            if (!confirm('Delete this category and all its tasks?')) return;
            
            playSound('delete');
            categories = categories.filter(c => c.id !== id);
            if (expandedCategory === id) expandedCategory = null;
            saveData();
            renderBubbles(true);
        }

        // Toggle category expansion
        function toggleCategory(id) {
            const wrapper = event.currentTarget.closest('.category-wrapper');
            
            if (expandedCategory === id) {
                expandedCategory = null;
            } else {
                // Create pop effect
                createPopEffect(wrapper);
                expandedCategory = id;
            }
            renderBubbles();
        }

        // Create pop particles and ripple
        function createPopEffect(wrapper) {
            const bubble = wrapper.querySelector('.bubble');
            const rect = bubble.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // Get bubble color
            const bubbleStyle = window.getComputedStyle(bubble);
            const bgImage = bubbleStyle.backgroundImage;
            
            // Extract color from gradient (simplified - gets first color)
            let particleColor = '#5D9CEC';
            const colorMatch = bgImage.match(/#[0-9A-Fa-f]{6}/);
            if (colorMatch) {
                particleColor = colorMatch[0];
            }
            
            // Create ripple
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            ripple.style.borderColor = particleColor;
            wrapper.appendChild(ripple);
            setTimeout(() => ripple.remove(), 800);
            
            // Create shatter lines
            const lineCount = 12;
            for (let i = 0; i < lineCount; i++) {
                const line = document.createElement('div');
                line.className = 'shatter-line';
                line.style.background = `linear-gradient(to bottom, ${particleColor}, transparent)`;
                
                const angle = (i / lineCount) * Math.PI * 2;
                const x = centerX + Math.cos(angle) * 50;
                const y = centerY + Math.sin(angle) * 50;
                
                line.style.left = x + 'px';
                line.style.top = y + 'px';
                line.style.transform = `rotate(${angle}rad)`;
                line.style.animation = `shatterExpand ${0.5 + Math.random() * 0.2}s ease-out forwards`;
                
                document.body.appendChild(line);
                setTimeout(() => line.remove(), 800);
            }
            
            // Create particles
            const particleCount = 20;
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'pop-particle';
                particle.style.background = particleColor;
                particle.style.boxShadow = `0 0 10px ${particleColor}`;
                
                const angle = (i / particleCount) * Math.PI * 2;
                const distance = 80 + Math.random() * 60;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.left = centerX + 'px';
                particle.style.top = centerY + 'px';
                particle.style.setProperty('--tx', tx + 'px');
                particle.style.setProperty('--ty', ty + 'px');
                particle.style.animation = `particleBurst ${0.6 + Math.random() * 0.3}s ease-out forwards`;
                
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1000);
            }
        }

        // Add task to category
        function addTask(categoryId, event) {
            if (event.key !== 'Enter') return;
            
            const input = event.target;
            const text = input.value.trim();
            
            if (text === '') return;
            
            const category = categories.find(c => c.id === categoryId);
            if (category) {
                category.tasks.push({
                    id: Date.now(),
                    text: text,
                    completed: false
                });
                input.value = '';
                saveData();
                renderBubbles();
            }
        }

        // Toggle task completion
        function toggleTask(categoryId, taskId, event) {
            event.stopPropagation();
            hapticFeedback('light');
            
            const category = categories.find(c => c.id === categoryId);
            if (category) {
                const task = category.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    if (task.completed) {
                        task.completedAt = Date.now();
                        hapticFeedback('heavy');
                        playSound('complete');
                    } else {
                        task.completedAt = null;
                        playSound('uncomplete');
                    }
                    saveData();
                    renderBubbles();
                    updateStats();
                }
            }
        }

        // Delete task
        function deleteTask(categoryId, taskId, event) {
            event.stopPropagation();
            playSound('delete');
            
            const category = categories.find(c => c.id === categoryId);
            if (category) {
                category.tasks = category.tasks.filter(t => t.id !== taskId);
                saveData();
                renderBubbles();
            }
        }

        // Render everything
        function renderBubbles(forcePhysicsRestart = false) {
            const container = document.getElementById('bubblesContainer');
            
            if (categories.length === 0) {
                container.innerHTML = '<div class="empty-state">Create your first category to get started</div>';
                stopBubblePhysics();
                return;
            }
            
            container.innerHTML = categories.map(category => {
                const isExpanded = expandedCategory === category.id;
                const isInactive = expandedCategory !== null && expandedCategory !== category.id;
                const taskCount = category.tasks.length;
                const completedCount = category.tasks.filter(t => t.completed).length;
                
                // Calculate dynamic category size
                const categorySize = calculateCategorySize(category);
                
                // Separate completed and outstanding tasks
                const outstandingTasks = category.tasks.filter(t => !t.completed);
                const completedTasks = category.tasks.filter(t => t.completed);
                
                // Calculate positions - outstanding tasks get priority positioning
                const allTasks = [...outstandingTasks, ...completedTasks];
                const taskBubblesHtml = allTasks.map((task, index) => {
                    const totalTasks = allTasks.length;
                    const angle = (index / totalTasks) * Math.PI * 2 - Math.PI / 2; // Start from top
                    const radius = task.completed ? 140 : 180; // Completed closer to center
                    const x = 50 + Math.cos(angle) * (radius / 6);
                    const y = 50 + Math.sin(angle) * (radius / 6);
                    const delay = index * 0.08;
                    
                    // Calculate dynamic size
                    const size = task.completed ? 80 : calculateBubbleSize(task);
                    
                    return `
                        <div class="task-bubble ${task.completed ? 'completed' : ''}" 
                             data-task-id="${task.id}"
                             style="left: ${x}%; top: ${y}%; animation-delay: ${delay}s; width: ${size}px; height: ${size}px;"
                             onclick="toggleTask(${category.id}, ${task.id}, event)"
                             ontouchstart="startLongPress('task', ${task.id}, ${category.id}, event)"
                             ontouchend="cancelLongPress()"
                             ontouchmove="cancelLongPress()"
                             oncontextmenu="event.preventDefault(); showEditMenu('task', ${task.id}, ${category.id}); return false;">
                            <div class="task-bubble-text">${escapeHtml(task.text)}</div>
                            <div class="task-bubble-delete" onclick="deleteTask(${category.id}, ${task.id}, event)">√ó</div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="category-wrapper ${isInactive ? 'inactive' : ''}" data-category-id="${category.id}">
                        <div class="bubble ${isExpanded ? 'expanded popped' : ''}" 
                             style="width: ${categorySize}px; height: ${categorySize}px;"
                             onclick="toggleCategory(${category.id})"
                             ontouchstart="startLongPress('category', ${category.id}, null, event)"
                             ontouchend="cancelLongPress()"
                             ontouchmove="cancelLongPress()"
                             oncontextmenu="event.preventDefault(); showEditMenu('category', ${category.id}); return false;">
                            <div class="bubble-text">${escapeHtml(category.name)}</div>
                            <div class="task-count">${completedCount}/${taskCount} tasks</div>
                            <div class="delete-category" onclick="deleteCategory(${category.id}, event)">√ó</div>
                        </div>
                        
                        <div class="tasks-panel ${isExpanded ? 'expanded' : ''}" onclick="closeOnEmptyClick(event, ${category.id})">
                            <div class="task-list">
                                ${taskBubblesHtml}
                                ${isExpanded ? `
                                    <div class="new-task-bubble" onclick="showTaskInput(${category.id}, event)">
                                        <div class="new-task-bubble-icon">+</div>
                                        <div class="new-task-bubble-text">New Task</div>
                                    </div>
                                    <button class="ai-prioritize-btn" onclick="smartReprioritize(${category.id}, event)">
                                        üß† Smart Priority
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Physics completely disabled - causes flickering with DOM re-renders
            // Only using CSS float animation for subtle movement
        }

        // Physics simulation for category bubbles
        let physicsRunning = false;
        let physicsAnimationFrame = null;
        let bubblePhysicsData = new Map(); // Store bubble positions and velocities

        function startBubblePhysics() {
            if (physicsRunning || expandedCategory !== null) return;
            
            physicsRunning = true;
            bubblePhysicsData.clear();
            
            // Get all category bubbles
            const wrappers = document.querySelectorAll('.category-wrapper:not(.inactive)');
            
            if (wrappers.length === 0) {
                physicsRunning = false;
                return;
            }
            
            // Initialize physics data for each bubble
            wrappers.forEach(wrapper => {
                const bubble = wrapper.querySelector('.bubble:not(.popped)');
                if (!bubble) return;
                
                const categoryId = wrapper.dataset.categoryId;
                const rect = bubble.getBoundingClientRect();
                
                bubblePhysicsData.set(categoryId, {
                    wrapper: wrapper,
                    bubble: bubble,
                    x: rect.left + rect.width / 2,
                    y: rect.top + rect.height / 2,
                    vx: (Math.random() - 0.5) * 0.3,
                    vy: (Math.random() - 0.5) * 0.3,
                    radius: rect.width / 2,
                    squishX: 1,
                    squishY: 1,
                    originalTransform: wrapper.style.transform || ''
                });
            });
            
            // Start animation loop
            animatePhysics();
        }

        function animatePhysics() {
            if (!physicsRunning || expandedCategory !== null) {
                stopBubblePhysics();
                return;
            }
            
            updatePhysics();
            physicsAnimationFrame = requestAnimationFrame(animatePhysics);
        }

        function updatePhysics() {
            const container = document.getElementById('bubblesContainer');
            if (!container) return;
            
            const containerRect = container.getBoundingClientRect();
            const damping = 0.995;
            const wallBounce = 0.4;
            const collisionDamping = 0.5;
            
            // Update each bubble's position
            bubblePhysicsData.forEach((data, id) => {
                // Apply velocity
                data.x += data.vx;
                data.y += data.vy;
                
                // Damping (friction)
                data.vx *= damping;
                data.vy *= damping;
                
                // Wall collisions
                const headerOffset = 120; // Space for header
                
                if (data.x - data.radius < containerRect.left) {
                    data.x = containerRect.left + data.radius;
                    data.vx = Math.abs(data.vx) * wallBounce;
                }
                if (data.x + data.radius > containerRect.right) {
                    data.x = containerRect.right - data.radius;
                    data.vx = -Math.abs(data.vx) * wallBounce;
                }
                if (data.y - data.radius < containerRect.top + headerOffset) {
                    data.y = containerRect.top + headerOffset + data.radius;
                    data.vy = Math.abs(data.vy) * wallBounce;
                }
                if (data.y + data.radius > containerRect.bottom) {
                    data.y = containerRect.bottom - data.radius;
                    data.vy = -Math.abs(data.vy) * wallBounce;
                }
                
                // Reset squish
                data.squishX = 1;
                data.squishY = 1;
            });
            
            // Check bubble-to-bubble collisions
            const bubbles = Array.from(bubblePhysicsData.entries());
            for (let i = 0; i < bubbles.length; i++) {
                for (let j = i + 1; j < bubbles.length; j++) {
                    const [id1, b1] = bubbles[i];
                    const [id2, b2] = bubbles[j];
                    
                    const dx = b2.x - b1.x;
                    const dy = b2.y - b1.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    const minDist = b1.radius + b2.radius;
                    
                    if (distance < minDist && distance > 0) {
                        // Collision!
                        const overlap = minDist - distance;
                        const angle = Math.atan2(dy, dx);
                        
                        // Separate bubbles
                        const separateX = Math.cos(angle) * overlap * 0.5;
                        const separateY = Math.sin(angle) * overlap * 0.5;
                        
                        b1.x -= separateX;
                        b1.y -= separateY;
                        b2.x += separateX;
                        b2.y += separateY;
                        
                        // Exchange velocities (elastic collision)
                        const tempVx = b1.vx;
                        const tempVy = b1.vy;
                        b1.vx = b2.vx * collisionDamping;
                        b1.vy = b2.vy * collisionDamping;
                        b2.vx = tempVx * collisionDamping;
                        b2.vy = tempVy * collisionDamping;
                        
                        // Apply squish based on collision direction
                        const squishAmount = Math.min(overlap / minDist * 0.3, 0.15);
                        
                        if (Math.abs(dx) > Math.abs(dy)) {
                            // Horizontal collision
                            b1.squishX = 1 - squishAmount;
                            b1.squishY = 1 + squishAmount * 0.5;
                            b2.squishX = 1 - squishAmount;
                            b2.squishY = 1 + squishAmount * 0.5;
                        } else {
                            // Vertical collision
                            b1.squishX = 1 + squishAmount * 0.5;
                            b1.squishY = 1 - squishAmount;
                            b2.squishX = 1 + squishAmount * 0.5;
                            b2.squishY = 1 - squishAmount;
                        }
                    }
                }
            }
            
            // Apply transforms to DOM elements
            bubblePhysicsData.forEach((data, id) => {
                if (!data.wrapper || !data.bubble) return;
                
                // Calculate offset from original position
                const wrapperRect = data.wrapper.getBoundingClientRect();
                const originalCenterX = wrapperRect.left + wrapperRect.width / 2;
                const originalCenterY = wrapperRect.top + wrapperRect.height / 2;
                
                // Only apply transform to wrapper, not recreate position
                const offsetX = data.x - originalCenterX;
                const offsetY = data.y - originalCenterY;
                
                data.wrapper.style.transform = `translate(${offsetX}px, ${offsetY}px)`;
                data.bubble.style.transform = `scale(${data.squishX}, ${data.squishY})`;
            });
        }

        function stopBubblePhysics() {
            physicsRunning = false;
            
            if (physicsAnimationFrame) {
                cancelAnimationFrame(physicsAnimationFrame);
                physicsAnimationFrame = null;
            }
            
            // Reset all transforms
            bubblePhysicsData.forEach((data, id) => {
                if (data.wrapper) {
                    data.wrapper.style.transform = data.originalTransform;
                }
                if (data.bubble) {
                    data.bubble.style.transform = 'scale(1, 1)';
                }
            });
            
            bubblePhysicsData.clear();
        }

        // Haptic feedback for mobile devices
        function hapticFeedback(type = 'light') {
            if ('vibrate' in navigator) {
                switch(type) {
                    case 'light':
                        navigator.vibrate(10);
                        break;
                    case 'medium':
                        navigator.vibrate(20);
                        break;
                    case 'heavy':
                        navigator.vibrate([30, 10, 30]);
                        break;
                }
            }
        }

        // Sound Effects System
        let audioContext = null;
        let soundEnabled = true;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            // Check saved preference
            const saved = localStorage.getItem('soundEnabled');
            soundEnabled = saved !== 'false'; // Default to true
        }

        function playSound(type) {
            if (!soundEnabled) return;
            
            initAudio();
            
            const now = audioContext.currentTime;
            
            switch(type) {
                case 'pop':
                    // Bubble pop - descending pitch with snap
                    const popOsc = audioContext.createOscillator();
                    const popGain = audioContext.createGain();
                    
                    popOsc.connect(popGain);
                    popGain.connect(audioContext.destination);
                    
                    popOsc.frequency.setValueAtTime(400, now);
                    popOsc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                    
                    popGain.gain.setValueAtTime(0.3, now);
                    popGain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    
                    popOsc.start(now);
                    popOsc.stop(now + 0.15);
                    break;
                    
                case 'click':
                    // Sharp click sound
                    const clickOsc = audioContext.createOscillator();
                    const clickGain = audioContext.createGain();
                    
                    clickOsc.connect(clickGain);
                    clickGain.connect(audioContext.destination);
                    
                    clickOsc.frequency.value = 800;
                    clickOsc.type = 'square';
                    
                    clickGain.gain.setValueAtTime(0.15, now);
                    clickGain.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
                    
                    clickOsc.start(now);
                    clickOsc.stop(now + 0.05);
                    break;
                    
                case 'complete':
                    // Success sound - rising chime
                    const comp1 = audioContext.createOscillator();
                    const comp2 = audioContext.createOscillator();
                    const compGain = audioContext.createGain();
                    
                    comp1.connect(compGain);
                    comp2.connect(compGain);
                    compGain.connect(audioContext.destination);
                    
                    comp1.frequency.value = 523; // C
                    comp2.frequency.value = 659; // E
                    
                    compGain.gain.setValueAtTime(0.2, now);
                    compGain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                    
                    comp1.start(now);
                    comp1.stop(now + 0.3);
                    comp2.start(now + 0.05);
                    comp2.stop(now + 0.35);
                    break;
                    
                case 'uncomplete':
                    // Undo sound - descending tone
                    const uncOsc = audioContext.createOscillator();
                    const uncGain = audioContext.createGain();
                    
                    uncOsc.connect(uncGain);
                    uncGain.connect(audioContext.destination);
                    
                    uncOsc.frequency.setValueAtTime(500, now);
                    uncOsc.frequency.exponentialRampToValueAtTime(300, now + 0.15);
                    
                    uncGain.gain.setValueAtTime(0.15, now);
                    uncGain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    
                    uncOsc.start(now);
                    uncOsc.stop(now + 0.15);
                    break;
                    
                case 'open':
                    // Opening sound - ascending whoosh
                    const openOsc = audioContext.createOscillator();
                    const openGain = audioContext.createGain();
                    const openFilter = audioContext.createBiquadFilter();
                    
                    openOsc.connect(openFilter);
                    openFilter.connect(openGain);
                    openGain.connect(audioContext.destination);
                    
                    openOsc.type = 'sawtooth';
                    openOsc.frequency.setValueAtTime(200, now);
                    openOsc.frequency.exponentialRampToValueAtTime(600, now + 0.2);
                    
                    openFilter.type = 'lowpass';
                    openFilter.frequency.setValueAtTime(1000, now);
                    openFilter.frequency.exponentialRampToValueAtTime(3000, now + 0.2);
                    
                    openGain.gain.setValueAtTime(0.1, now);
                    openGain.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
                    
                    openOsc.start(now);
                    openOsc.stop(now + 0.25);
                    break;
                    
                case 'close':
                    // Closing sound - descending whoosh
                    const closeOsc = audioContext.createOscillator();
                    const closeGain = audioContext.createGain();
                    
                    closeOsc.connect(closeGain);
                    closeGain.connect(audioContext.destination);
                    
                    closeOsc.type = 'sine';
                    closeOsc.frequency.setValueAtTime(600, now);
                    closeOsc.frequency.exponentialRampToValueAtTime(200, now + 0.15);
                    
                    closeGain.gain.setValueAtTime(0.1, now);
                    closeGain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    
                    closeOsc.start(now);
                    closeOsc.stop(now + 0.15);
                    break;
                    
                case 'delete':
                    // Delete sound - downward sweep
                    const delOsc = audioContext.createOscillator();
                    const delGain = audioContext.createGain();
                    
                    delOsc.connect(delGain);
                    delGain.connect(audioContext.destination);
                    
                    delOsc.frequency.setValueAtTime(800, now);
                    delOsc.frequency.exponentialRampToValueAtTime(100, now + 0.2);
                    delOsc.type = 'sawtooth';
                    
                    delGain.gain.setValueAtTime(0.2, now);
                    delGain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                    
                    delOsc.start(now);
                    delOsc.stop(now + 0.2);
                    break;
                    
                case 'add':
                    // Add sound - cheerful blip
                    const addOsc = audioContext.createOscillator();
                    const addGain = audioContext.createGain();
                    
                    addOsc.connect(addGain);
                    addGain.connect(audioContext.destination);
                    
                    addOsc.frequency.value = 700;
                    
                    addGain.gain.setValueAtTime(0.2, now);
                    addGain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    
                    addOsc.start(now);
                    addOsc.stop(now + 0.1);
                    break;
            }
        }

        // Toggle category and manage physics
        function toggleCategory(id) {
            hapticFeedback('medium');
            const wrapper = event.currentTarget.closest('.category-wrapper');
            
            if (expandedCategory === id) {
                playSound('close');
                expandedCategory = null;
            } else {
                playSound('pop');
                createPopEffect(wrapper);
                expandedCategory = id;
            }
            renderBubbles();
        }

        // Close category when clicking empty space in tasks panel
        function closeOnEmptyClick(event, categoryId) {
            // Only close if clicking directly on the tasks-panel or task-list (empty space)
            // Don't close if clicking on task bubbles, new task button, or smart priority button
            if (event.target.classList.contains('tasks-panel') || 
                event.target.classList.contains('task-list')) {
                expandedCategory = null;
                renderBubbles();
            }
        }

        // Show task input overlay
        let currentCategoryForTask = null;
        let selectedDueDays = null; // null = someday
        
        function showTaskInput(categoryId, event) {
            event.stopPropagation();
            currentCategoryForTask = categoryId;
            selectedDueDays = null; // Reset to someday
            
            // Reset date button selection
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.days === 'null') btn.classList.add('selected');
            });
            
            const overlay = document.getElementById('taskInputOverlay');
            overlay.classList.add('active');
            setTimeout(() => {
                document.getElementById('taskInputField').focus();
            }, 100);
        }

        function selectDate(days, event) {
            event.stopPropagation();
            selectedDueDays = days;
            
            // Update button selection
            document.querySelectorAll('.date-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function hideTaskInput() {
            const overlay = document.getElementById('taskInputOverlay');
            overlay.classList.remove('active');
            document.getElementById('taskInputField').value = '';
            currentCategoryForTask = null;
            selectedDueDays = null;
        }

        function submitTask(event) {
            if (event.key !== 'Enter') return;
            
            const input = document.getElementById('taskInputField');
            const text = input.value.trim();
            
            if (text === '' || currentCategoryForTask === null) return;
            
            const category = categories.find(c => c.id === currentCategoryForTask);
            if (category) {
                const now = Date.now();
                const dueDate = selectedDueDays !== null ? now + (selectedDueDays * 24 * 60 * 60 * 1000) : null;
                
                category.tasks.push({
                    id: now,
                    text: text,
                    completed: false,
                    createdAt: now,
                    dueDate: dueDate,
                    aiPriority: null
                });
                saveData();
                renderBubbles();
                hideTaskInput();
            }
        }

        // Calculate bubble size based on age and AI priority
        function calculateBubbleSize(task) {
            const baseSize = 100; // Minimum size
            const maxSize = 180; // Maximum size
            
            // Time-based growth (automatic)
            const ageInDays = (Date.now() - task.createdAt) / (1000 * 60 * 60 * 24);
            const timeGrowth = Math.min(ageInDays * 15, 60); // +15px per day, max +60px
            
            // AI priority adjustment (0-100 scale, if available)
            const aiGrowth = task.aiPriority ? (task.aiPriority / 100) * 40 : 0; // max +40px
            
            // Combine both factors
            const totalSize = Math.min(baseSize + timeGrowth + aiGrowth, maxSize);
            
            return totalSize;
        }

        // Calculate dynamic category bubble size
        function calculateCategorySize(category) {
            const baseSize = 200; // Minimum size
            let size = baseSize;
            
            const totalTasks = category.tasks.length;
            const activeTasks = category.tasks.filter(t => !t.completed).length;
            const completedTasks = totalTasks - activeTasks;
            
            // No tasks = smaller bubble
            if (totalTasks === 0) {
                return baseSize - 30; // 170px for empty categories
            }
            
            // Size based on number of active tasks (more tasks = bigger bubble)
            const taskSizeBonus = Math.min(activeTasks * 8, 60); // +8px per active task, max +60px
            size += taskSizeBonus;
            
            // Urgency based on overdue/due soon tasks
            const now = Date.now();
            let urgencyBonus = 0;
            
            category.tasks.forEach(task => {
                if (task.completed) return;
                
                // Check due dates
                if (task.dueDate) {
                    const daysUntilDue = (task.dueDate - now) / (1000 * 60 * 60 * 24);
                    
                    if (daysUntilDue < 0) {
                        urgencyBonus += 15; // Overdue task
                    } else if (daysUntilDue < 1) {
                        urgencyBonus += 10; // Due today
                    } else if (daysUntilDue < 2) {
                        urgencyBonus += 5; // Due tomorrow
                    }
                }
                
                // Check AI priority
                if (task.aiPriority && task.aiPriority > 70) {
                    urgencyBonus += 8; // High priority task
                }
                
                // Check age (old tasks are urgent)
                const ageInDays = (now - task.createdAt) / (1000 * 60 * 60 * 24);
                if (ageInDays > 7) {
                    urgencyBonus += 5; // Been sitting for a week
                }
            });
            
            size += Math.min(urgencyBonus, 80); // Cap urgency bonus at +80px
            
            // Completion bonus (nearly done categories get slightly bigger for motivation)
            if (totalTasks > 0 && activeTasks > 0) {
                const completionRate = completedTasks / totalTasks;
                if (completionRate > 0.7) {
                    size += 15; // Almost done! Make it prominent
                }
            }
            
            return Math.min(Math.max(size, 170), 300); // Between 170px and 300px
        }

        // Smart keyword-based prioritization (no API needed)
        function smartReprioritize(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category || category.tasks.length === 0) return;
            
            // Show feedback
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '‚è≥ Analyzing...';
            button.disabled = true;
            
            const now = Date.now();
            
            // Analyze each incomplete task
            category.tasks.forEach(task => {
                if (task.completed) return;
                
                let score = 50; // Base score
                const text = task.text.toLowerCase();
                
                // Due date urgency (0-35 points based on how soon)
                if (task.dueDate) {
                    const daysUntilDue = (task.dueDate - now) / (1000 * 60 * 60 * 24);
                    if (daysUntilDue < 0) {
                        score += 35; // Overdue!
                    } else if (daysUntilDue < 1) {
                        score += 30; // Due today
                    } else if (daysUntilDue < 2) {
                        score += 20; // Due tomorrow
                    } else if (daysUntilDue < 7) {
                        score += 10; // Due this week
                    }
                }
                
                // Urgency keywords (+30)
                if (text.match(/\b(urgent|asap|critical|emergency|now|immediately)\b/)) {
                    score += 30;
                }
                
                // Time-sensitive keywords (+25)
                if (text.match(/\b(today|tonight|deadline|due|tomorrow|this week)\b/)) {
                    score += 25;
                }
                
                // Importance keywords (+20)
                if (text.match(/\b(important|must|need|essential|vital|key|priority)\b/)) {
                    score += 20;
                }
                
                // Negative priority keywords (-20)
                if (text.match(/\b(maybe|someday|eventually|consider|think about|when i have time)\b/)) {
                    score -= 20;
                }
                
                // Action verbs suggest actionable tasks (+10)
                if (text.match(/\b(fix|call|send|finish|complete|review|update|prepare)\b/)) {
                    score += 10;
                }
                
                // Exclamation marks = urgency (+5 each, max 15)
                const exclamations = (text.match(/!/g) || []).length;
                score += Math.min(exclamations * 5, 15);
                
                // Cap score between 0-100
                task.aiPriority = Math.max(0, Math.min(100, score));
            });
            
            category.lastAIPrioritization = Date.now();
            saveData();
            renderBubbles();
            
            button.innerHTML = '‚úì Prioritized!';
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
        }
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Allow Enter key for category
        document.getElementById('categoryInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addCategory();
            }
        });

        // Load on page load
        loadData();
        updateStats();
        renderBubbles(); // No physics - just render

        // Side Panel Functions
        function toggleSidePanel() {
            const panel = document.getElementById('sidePanel');
            const overlay = document.getElementById('panelOverlay');
            const menuBtn = document.getElementById('menuBtn');
            
            panel.classList.toggle('open');
            overlay.classList.toggle('active');
            menuBtn.classList.toggle('active');
            
            if (panel.classList.contains('open')) {
                updateStats();
            }
        }

        function updateStats() {
            let totalTasks = 0;
            let completedTasks = 0;
            let todayCompleted = 0;
            const today = new Date().setHours(0, 0, 0, 0);
            
            categories.forEach(cat => {
                totalTasks += cat.tasks.length;
                cat.tasks.forEach(task => {
                    if (task.completed) {
                        completedTasks++;
                        // Check if completed today (would need completedAt timestamp)
                        if (task.completedAt && new Date(task.completedAt).setHours(0, 0, 0, 0) === today) {
                            todayCompleted++;
                        }
                    }
                });
            });
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('totalCategories').textContent = categories.length;
            document.getElementById('todayCompleted').textContent = todayCompleted;
            document.getElementById('activeBadge').textContent = (totalTasks - completedTasks) + ' active';
        }

        function showHistory() {
            toggleSidePanel();
            playSound('open');
            
            const modal = document.getElementById('listViewModal');
            const title = document.getElementById('listViewTitle');
            const body = document.getElementById('listViewBody');
            
            title.textContent = 'üìú History';
            
            // Get all completed tasks
            let completedTasks = [];
            categories.forEach(cat => {
                cat.tasks.filter(t => t.completed).forEach(task => {
                    completedTasks.push({
                        ...task,
                        categoryName: cat.name,
                        categoryId: cat.id
                    });
                });
            });
            
            // Sort by completion time (most recent first)
            completedTasks.sort((a, b) => (b.completedAt || 0) - (a.completedAt || 0));
            
            if (completedTasks.length === 0) {
                body.innerHTML = '<div class="empty-list">No completed tasks yet.<br>Complete some tasks to see them here!</div>';
            } else {
                body.innerHTML = completedTasks.map(task => {
                    const timeAgo = getTimeAgo(task.completedAt);
                    return `
                        <div class="list-task-item completed">
                            <div class="list-task-checkbox"></div>
                            <div class="list-task-text">${escapeHtml(task.text)}</div>
                            <div class="list-task-time">${timeAgo}</div>
                        </div>
                    `;
                }).join('');
            }
            
            modal.classList.add('active');
        }

        function showAllTasks() {
            toggleSidePanel();
            playSound('open');
            
            const modal = document.getElementById('listViewModal');
            const title = document.getElementById('listViewTitle');
            const body = document.getElementById('listViewBody');
            
            title.textContent = 'üìã All Tasks';
            
            if (categories.length === 0) {
                body.innerHTML = '<div class="empty-list">No tasks yet.<br>Create a category to get started!</div>';
                modal.classList.add('active');
                return;
            }
            
            let html = '';
            categories.forEach(cat => {
                const activeTasks = cat.tasks.filter(t => !t.completed);
                const completedTasks = cat.tasks.filter(t => t.completed);
                const allTasks = [...activeTasks, ...completedTasks];
                
                if (allTasks.length === 0) return;
                
                html += `
                    <div class="list-category-section">
                        <div class="list-category-header">
                            ${escapeHtml(cat.name)}
                            <span class="list-category-count">${activeTasks.length}/${cat.tasks.length} active</span>
                        </div>
                `;
                
                allTasks.forEach(task => {
                    const timeInfo = task.completed 
                        ? getTimeAgo(task.completedAt)
                        : task.dueDate 
                            ? 'Due ' + getDueText(task.dueDate)
                            : getTimeAgo(task.createdAt) + ' ago';
                    
                    html += `
                        <div class="list-task-item ${task.completed ? 'completed' : ''}" 
                             onclick="toggleTaskFromList(${cat.id}, ${task.id})">
                            <div class="list-task-checkbox"></div>
                            <div class="list-task-text">${escapeHtml(task.text)}</div>
                            <div class="list-task-time">${timeInfo}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            body.innerHTML = html || '<div class="empty-list">No tasks found.</div>';
            modal.classList.add('active');
        }

        function showTotalTasks() {
            showAllTasks(); // Same as "All Tasks" - shows everything
        }

        function showCompletedTasks() {
            toggleSidePanel();
            playSound('open');
            
            const modal = document.getElementById('listViewModal');
            const title = document.getElementById('listViewTitle');
            const body = document.getElementById('listViewBody');
            
            title.textContent = '‚úÖ Completed Tasks';
            
            let html = '';
            let totalCompleted = 0;
            
            categories.forEach(cat => {
                const completedTasks = cat.tasks.filter(t => t.completed);
                totalCompleted += completedTasks.length;
                
                if (completedTasks.length === 0) return;
                
                html += `
                    <div class="list-category-section">
                        <div class="list-category-header">
                            ${escapeHtml(cat.name)}
                            <span class="list-category-count">${completedTasks.length} completed</span>
                        </div>
                `;
                
                completedTasks.forEach(task => {
                    const timeInfo = getTimeAgo(task.completedAt);
                    
                    html += `
                        <div class="list-task-item completed" 
                             onclick="toggleTaskFromList(${cat.id}, ${task.id})">
                            <div class="list-task-checkbox"></div>
                            <div class="list-task-text">${escapeHtml(task.text)}</div>
                            <div class="list-task-time">${timeInfo}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            body.innerHTML = html || '<div class="empty-list">No completed tasks yet.<br>Complete some tasks to see them here!</div>';
            modal.classList.add('active');
        }

        function showAllCategories() {
            toggleSidePanel();
            
            const modal = document.getElementById('listViewModal');
            const title = document.getElementById('listViewTitle');
            const body = document.getElementById('listViewBody');
            
            title.textContent = 'üìÇ Categories';
            
            if (categories.length === 0) {
                body.innerHTML = '<div class="empty-list">No categories yet.<br>Create your first category to get started!</div>';
                modal.classList.add('active');
                return;
            }
            
            let html = '';
            
            categories.forEach(cat => {
                const totalTasks = cat.tasks.length;
                const completedTasks = cat.tasks.filter(t => t.completed).length;
                const activeTasks = totalTasks - completedTasks;
                const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
                
                html += `
                    <div class="list-task-item" style="cursor: default;">
                        <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #5D9CEC, #4A89DC); display: flex; align-items: center; justify-content: center; font-size: 20px;">
                            ${cat.name.charAt(0).toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <div style="color: #ECF0F1; font-size: 18px; margin-bottom: 5px;">${escapeHtml(cat.name)}</div>
                            <div style="color: #95A5A6; font-size: 14px;">${activeTasks} active ‚Ä¢ ${completedTasks} completed ‚Ä¢ ${percentage}% done</div>
                        </div>
                    </div>
                `;
            });
            
            body.innerHTML = html;
            modal.classList.add('active');
        }

        function showTodayCompleted() {
            toggleSidePanel();
            
            const modal = document.getElementById('listViewModal');
            const title = document.getElementById('listViewTitle');
            const body = document.getElementById('listViewBody');
            
            title.textContent = 'üéØ Completed Today';
            
            const today = new Date().setHours(0, 0, 0, 0);
            let html = '';
            let totalToday = 0;
            
            categories.forEach(cat => {
                const todayTasks = cat.tasks.filter(t => {
                    if (!t.completed || !t.completedAt) return false;
                    const completedDate = new Date(t.completedAt).setHours(0, 0, 0, 0);
                    return completedDate === today;
                });
                
                totalToday += todayTasks.length;
                
                if (todayTasks.length === 0) return;
                
                html += `
                    <div class="list-category-section">
                        <div class="list-category-header">
                            ${escapeHtml(cat.name)}
                            <span class="list-category-count">${todayTasks.length} today</span>
                        </div>
                `;
                
                todayTasks.forEach(task => {
                    const timeInfo = getTimeAgo(task.completedAt);
                    
                    html += `
                        <div class="list-task-item completed">
                            <div class="list-task-checkbox"></div>
                            <div class="list-task-text">${escapeHtml(task.text)}</div>
                            <div class="list-task-time">${timeInfo}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            if (totalToday === 0) {
                body.innerHTML = '<div class="empty-list">No tasks completed today yet.<br>Get started and mark some tasks as done! üöÄ</div>';
            } else {
                body.innerHTML = html;
            }
            
            modal.classList.add('active');
        }

        function closeListView() {
            playSound('close');
            document.getElementById('listViewModal').classList.remove('active');
        }

        function toggleSidePanel() {
            playSound('click');
            const panel = document.getElementById('sidePanel');
            const overlay = document.getElementById('panelOverlay');
            const menuBtn = document.getElementById('menuBtn');
            
            panel.classList.toggle('open');
            overlay.classList.toggle('active');
            menuBtn.classList.toggle('active');
            
            if (panel.classList.contains('open')) {
                updateStats();
            }
        }

        function toggleTaskFromList(categoryId, taskId) {
            hapticFeedback('light');
            
            const category = categories.find(c => c.id === categoryId);
            if (category) {
                const task = category.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    if (task.completed) {
                        task.completedAt = Date.now();
                        hapticFeedback('heavy');
                        playSound('complete');
                    } else {
                        task.completedAt = null;
                        playSound('uncomplete');
                    }
                    saveData();
                    updateStats();
                    
                    // Refresh the current list view
                    const title = document.getElementById('listViewTitle').textContent;
                    if (title.includes('History')) {
                        showHistory();
                    } else {
                        showAllTasks();
                    }
                }
            }
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return 'Unknown';
            
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return days === 1 ? '1 day ago' : `${days} days ago`;
            if (hours > 0) return hours === 1 ? '1 hour ago' : `${hours} hours ago`;
            if (minutes > 0) return minutes === 1 ? '1 min ago' : `${minutes} mins ago`;
            return 'Just now';
        }

        function getDueText(dueDate) {
            const now = Date.now();
            const diff = dueDate - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(hours / 24);
            
            if (diff < 0) return 'Overdue';
            if (days === 0) return 'today';
            if (days === 1) return 'tomorrow';
            return `in ${days} days`;
        }

        // Edit Menu System
        let editTarget = null;
        let editType = null; // 'category' or 'task'
        let longPressTimer = null;

        function showEditMenu(type, id, categoryId = null) {
            playSound('open');
            editType = type;
            editTarget = { id, categoryId };
            
            const overlay = document.getElementById('editMenuOverlay');
            const menu = document.getElementById('editMenu');
            const title = document.getElementById('editMenuTitle');
            const content = document.getElementById('editMenuContent');
            
            if (type === 'category') {
                const category = categories.find(c => c.id === id);
                title.textContent = `Edit "${category.name}"`;
                
                content.innerHTML = `
                    <div class="edit-menu-item" onclick="renameCategory(${id})">
                        <div class="edit-menu-item-icon">‚úèÔ∏è</div>
                        <div class="edit-menu-item-text">Rename Category</div>
                    </div>
                    <div class="edit-menu-item danger" onclick="confirmDelete('category', ${id})">
                        <div class="edit-menu-item-icon">üóëÔ∏è</div>
                        <div class="edit-menu-item-text">Delete Category</div>
                    </div>
                `;
            } else {
                const category = categories.find(c => c.id === categoryId);
                const task = category.tasks.find(t => t.id === id);
                title.textContent = 'Edit Task';
                
                content.innerHTML = `
                    <div class="edit-menu-item" onclick="renameTask(${categoryId}, ${id})">
                        <div class="edit-menu-item-icon">‚úèÔ∏è</div>
                        <div class="edit-menu-item-text">Rename Task</div>
                    </div>
                    <div class="edit-menu-item" onclick="changeDueDate(${categoryId}, ${id})">
                        <div class="edit-menu-item-icon">üìÖ</div>
                        <div class="edit-menu-item-text">Change Due Date</div>
                    </div>
                    <div class="edit-menu-item danger" onclick="confirmDelete('task', ${id}, ${categoryId})">
                        <div class="edit-menu-item-icon">üóëÔ∏è</div>
                        <div class="edit-menu-item-text">Delete Task</div>
                    </div>
                `;
            }
            
            overlay.classList.add('active');
            menu.classList.add('active');
        }

        function closeEditMenu() {
            playSound('close');
            const overlay = document.getElementById('editMenuOverlay');
            const menu = document.getElementById('editMenu');
            overlay.classList.remove('active');
            menu.classList.remove('active');
            editTarget = null;
            editType = null;
        }

        function renameCategory(id) {
            closeEditMenu();
            const category = categories.find(c => c.id === id);
            showRenameModal('category', category.name, id);
        }

        function renameTask(categoryId, taskId) {
            closeEditMenu();
            const category = categories.find(c => c.id === categoryId);
            const task = category.tasks.find(t => t.id === taskId);
            showRenameModal('task', task.text, taskId, categoryId);
        }

        function showRenameModal(type, currentName, id, categoryId = null) {
            const modal = document.getElementById('renameModal');
            const title = document.getElementById('renameModalTitle');
            const input = document.getElementById('renameInput');
            
            title.textContent = type === 'category' ? 'Rename Category' : 'Rename Task';
            input.value = currentName;
            
            editType = type;
            editTarget = { id, categoryId };
            
            modal.classList.add('active');
            setTimeout(() => input.focus(), 100);
        }

        function closeRenameModal() {
            const modal = document.getElementById('renameModal');
            modal.classList.remove('active');
            editTarget = null;
            editType = null;
        }

        function saveRename() {
            const input = document.getElementById('renameInput');
            const newName = input.value.trim();
            
            if (newName === '') return;
            
            playSound('click');
            
            if (editType === 'category') {
                const category = categories.find(c => c.id === editTarget.id);
                if (category) {
                    category.name = newName;
                }
            } else {
                const category = categories.find(c => c.id === editTarget.categoryId);
                if (category) {
                    const task = category.tasks.find(t => t.id === editTarget.id);
                    if (task) {
                        task.text = newName;
                    }
                }
            }
            
            saveData();
            renderBubbles();
            closeRenameModal();
        }

        function changeDueDate(categoryId, taskId) {
            closeEditMenu();
            const category = categories.find(c => c.id === categoryId);
            const task = category.tasks.find(t => t.id === taskId);
            
            // Simple prompt for now - can be made fancier
            const choice = confirm('Choose due date:\nOK = Show date picker\nCancel = Clear due date');
            
            if (choice) {
                // Show date options
                showDatePicker(categoryId, taskId);
            } else {
                task.dueDate = null;
                saveData();
                renderBubbles();
            }
        }

        function showDatePicker(categoryId, taskId) {
            const now = Date.now();
            const today = 0;
            const tomorrow = 24 * 60 * 60 * 1000;
            const week = 7 * 24 * 60 * 60 * 1000;
            
            const choice = prompt('Set due date:\n1 = Today\n2 = Tomorrow\n3 = This Week\n0 = Clear', '1');
            
            const category = categories.find(c => c.id === categoryId);
            const task = category.tasks.find(t => t.id === taskId);
            
            switch(choice) {
                case '1':
                    task.dueDate = now + today;
                    break;
                case '2':
                    task.dueDate = now + tomorrow;
                    break;
                case '3':
                    task.dueDate = now + week;
                    break;
                case '0':
                    task.dueDate = null;
                    break;
                default:
                    return;
            }
            
            saveData();
            renderBubbles();
        }

        function confirmDelete(type, id, categoryId = null) {
            closeEditMenu();
            
            if (type === 'category') {
                if (confirm('Delete this category and all its tasks?')) {
                    playSound('delete');
                    categories = categories.filter(c => c.id !== id);
                    if (expandedCategory === id) expandedCategory = null;
                    saveData();
                    renderBubbles();
                }
            } else {
                playSound('delete');
                const category = categories.find(c => c.id === categoryId);
                if (category) {
                    category.tasks = category.tasks.filter(t => t.id !== id);
                    saveData();
                    renderBubbles();
                }
            }
        }

        // Long press detection
        function startLongPress(type, id, categoryId, event) {
            event.preventDefault();
            longPressTimer = setTimeout(() => {
                hapticFeedback('medium');
                showEditMenu(type, id, categoryId);
            }, 500); // 500ms long press
        }

        function cancelLongPress() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }

        function toggleSound(event) {
            event.stopPropagation();
            const toggle = document.getElementById('soundToggle');
            toggle.classList.toggle('active');
            soundEnabled = toggle.classList.contains('active');
            localStorage.setItem('soundEnabled', soundEnabled);
            
            // Play a test sound if enabled
            if (soundEnabled) {
                playSound('click');
            }
        }

        function toggleDarkMode(event) {
            event.stopPropagation();
            const toggle = document.getElementById('darkModeToggle');
            toggle.classList.toggle('active');
            const enabled = toggle.classList.contains('active');
            localStorage.setItem('darkMode', enabled);
            // Dark mode is default, light mode would change the gradient
            if (!enabled) {
                document.body.style.background = 'linear-gradient(135deg, #ECF0F1 0%, #BDC3C7 100%)';
            } else {
                document.body.style.background = 'linear-gradient(135deg, #2C3E50 0%, #34495E 100%)';
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(categories, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'bubble-backup.json';
            link.click();
            toggleSidePanel();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        categories = imported;
                        saveData();
                        renderBubbles();
                        updateStats();
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
            toggleSidePanel();
        }

        function clearAllData() {
            if (confirm('Are you sure? This will delete ALL categories and tasks permanently.')) {
                categories = [];
                saveData();
                renderBubbles();
                updateStats();
                toggleSidePanel();
            }
        }

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ PWA installed! Service Worker registered:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
    </script>
    </div> <!-- end container -->

    <!-- List View Modal -->
    <div class="list-view-modal" id="listViewModal">
        <div class="list-view-content">
            <div class="list-view-header">
                <div class="list-view-title" id="listViewTitle">All Tasks</div>
                <div class="list-view-close" onclick="closeListView()">√ó</div>
            </div>
            <div id="listViewBody"></div>
        </div>
    </div>

    <!-- Edit Menu -->
    <div class="edit-menu-overlay" id="editMenuOverlay" onclick="closeEditMenu()"></div>
    <div class="edit-menu" id="editMenu">
        <div class="edit-menu-handle"></div>
        <div class="edit-menu-header">
            <div class="edit-menu-title" id="editMenuTitle">Edit</div>
        </div>
        <div id="editMenuContent"></div>
    </div>

    <!-- Rename Modal -->
    <div class="rename-modal" id="renameModal">
        <h3 id="renameModalTitle">Rename</h3>
        <input type="text" id="renameInput" placeholder="Enter new name..." onkeypress="if(event.key === 'Enter') saveRename()">
        <div class="rename-modal-buttons">
            <button class="cancel" onclick="closeRenameModal()">Cancel</button>
            <button class="save" onclick="saveRename()">Save</button>
        </div>
    </div>

</body>
</html>
